<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="img/logo2.png" type="image/png" />
<title>Dashboard | IngreChec</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  :root {
    --primary: #16a34a;
    --primary-hover: #22c55e;
    --background: #ffffff;
    --foreground: #0f0f0f;
    --muted: #f6f6f6;
    --muted-foreground: #6b7280;
    --border: #e5e7eb;
    --card: #ffffff;
    --card-foreground: #0f0f0f;
    --ring: #16a34a;
    --transition: all 0.3s ease;
    --glass-green: rgba(22, 163, 74, 0.8);
  }

  .dark {
    --background: #0f0f0f;
    --foreground: #f9fafb;
    --muted: #1f2937;
    --muted-foreground: #9ca3af;
    --border: #374151;
    --card: #1f2937;
    --card-foreground: #f9fafb;
    --glass-green: rgba(22, 163, 74, 0.6);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    transition: var(--transition);
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    background-color: var(--background);
    color: var(--foreground);
    scroll-behavior: smooth;
    min-height: 100vh;
  }
  
 /* Header (Glassmorphism Applied) */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 30px;
  background: rgba(255, 255, 255, 0.1);  /* Transparent for light */
  backdrop-filter: blur(10px);            /* Glass blur */
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 5px 20px rgba(0,0,0,0.07);
  position: sticky;
  top: 0;
  z-index: 1000;
  animation: slideDown 0.5s ease;
  border-bottom: 1px solid rgba(255, 255, 255, 0.3); /* Subtle frosted edge */
}

/* Dark mode glass nav */
.dark header {
  background: rgba(15, 15, 15, 0.4);      /* Dark frosted glass */
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

  .header.scrolled {
      background: (--background);
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
  .logo { 
    font-size:26px; 
    color: var(--primary); 
    font-weight:800;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  

  section {
    display:flex; 
    flex-direction:column; 
    align-items:center;
    padding:25px 0; 
    background: linear-gradient(to right, var(--primary), var(--primary-hover));
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .menu { 
    display:flex; 
    justify-content:center; 
    gap:12px; 
    flex-wrap: wrap; 
    margin-bottom: 15px;
  }
  
  /* Updated Button Styles */
  .btn {
    text-decoration: none;
    color: #fff;
    background-color: var(--primary);
    padding: 14px 30px;
    display: inline-block;
    border-radius: 50px;
    font-weight: 600;
    font-size: 18px;
    position: relative;
    overflow: hidden;
    transition: all 0.4s ease;
    box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: linear-gradient(135deg, var(--glass-green) 0%, var(--primary) 100%);
    backdrop-filter: blur(5px);
    cursor: pointer;
    text-align: center;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: 0.5s;
  }

  .btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(22, 163, 74, 0.4);
    text-decoration: none;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
  }

  .btn:hover::before {
    left: 100%;
  }

  .menu button {
    padding: 12px 24px;
    border: none;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 50px;
    cursor: pointer;
    font-size: 16px;
    color: white;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  .menu button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: 0.5s;
  }

  .menu button:hover::before {
    left: 100%;
  }
  
  .menu button.active, .menu button:hover { 
    background: rgba(255, 255, 255, 0.3); 
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }

  .btn.logout { 
    background: rgba(255, 255, 255, 0.9); 
    color: var(--primary);
    border: none; 
    padding: 12px 24px;
    border-radius: 50px; 
    cursor: pointer; 
    font-weight: 600;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  .btn.logout::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: 0.5s;
  }

  .btn.logout:hover::before {
    left: 100%;
  }
  
  .btn.logout:hover {
    background: white;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  
  .header-right { 
    margin-top:10px; 
    text-align:center; 
    font-weight:bold; 
    font-size: 20px; 
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    animation: fadeIn 1s ease;
  }

  main { 
    padding:40px 20px; 
    max-width:1000px; 
    margin:auto; 
    animation: fadeIn 0.8s ease;
  }

  .section { 
    display:none; 
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.5s ease, transform 0.5s ease;
  }
  
  .section.active { 
    display:block; 
    opacity: 1;
    transform: translateY(0);
    animation: fadeInUp 0.5s ease;
  }

  .user-card, .ocr-section, .history-section, .features {
    background: var(--card); 
    padding:25px; 
    border-radius:16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
    margin-bottom:30px;
    transition: var(--transition);
    border: 1px solid var(--border);
  }
  
  .user-card:hover, .ocr-section:hover, .history-section:hover, .features:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  }
  
  .section-title { 
    font-size:22px; 
    margin-bottom:20px; 
    color: var(--primary);
    border-bottom:2px solid var(--primary); 
    padding-bottom:10px; 
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .section-title::before {
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
  }

  .upload-area { 
    border:2px dashed var(--primary); 
    border-radius:16px; 
    padding:40px; 
    text-align:center; 
    cursor:pointer; 
    margin-bottom:20px; 
    transition:0.3s; 
    background: rgba(22, 163, 74, 0.03);
  }
  
  .upload-area:hover { 
    background: rgba(22, 163, 74, 0.08); 
    transform: scale(1.01);
  }
  
  .upload-icon { 
    font-size:3.5rem; 
    color: var(--primary); 
    margin-bottom:15px;
    animation: bounce 3s infinite;
  }

  .image-preview { 
    margin-top:20px; 
    background: var(--muted); 
    border-radius:12px; 
    padding:15px; 
    text-align:center; 
    overflow: hidden;
    transition: var(--transition);
  }
  
  .image-preview img { 
    max-width:100%; 
    border-radius:8px; 
    transition: var(--transition);
  }
  
  .image-preview:hover img {
    transform: scale(1.02);
  }

  .btn.extract, .btn.analyze {
    display:inline-block; 
    margin:5px 8px 5px 0;
    border-radius:50px;
    color:#fff; 
    border:none;
    cursor: pointer;
    transition: all 0.4s ease;
    box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: linear-gradient(135deg, var(--glass-green) 0%, var(--primary) 100%);
    backdrop-filter: blur(5px);
    position: relative;
    overflow: hidden;
  }

  .btn.extract::before, .btn.analyze::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: 0.5s;
  }

  .btn.extract:hover::before, .btn.analyze:hover::before {
    left: 100%;
  }
  
  .btn.extract { 
    background: linear-gradient(135deg, var(--glass-green) 0%, var(--primary) 100%);
  }
  
  .btn.extract:hover { 
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(22, 163, 74, 0.4);
  }
  
  .btn.analyze { 
    background: linear-gradient(135deg, var(--glass-green) 0%, var(--primary) 100%);
  }
  
  .btn.analyze:hover { 
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(22, 163, 74, 0.4);
  }

  textarea { 
    width:100%; 
    height:150px; 
    padding:15px; 
    border-radius:12px;
    border:1px solid var(--border); 
    margin-top:15px; 
    resize:vertical; 
    font-family:inherit; 
    transition: var(--transition);
    background: var(--muted);
    color: var(--foreground);
  }
  
  textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.2);
  }

  .history-list { 
    list-style:none; 
    padding:0; 
  }
  
  .history-item {
    background: var(--card); 
    padding:15px 20px; 
    border-radius:12px;
    margin-bottom:12px; 
    display:flex; 
    justify-content:space-between; 
    align-items:center;
    box-shadow:0 3px 10px rgba(0,0,0,0.05);
    transition: var(--transition);
    border-left: 4px solid var(--primary);
  }
  
  .history-item:hover {
    transform: translateX(5px);
    box-shadow:0 5px 15px rgba(0,0,0,0.08);
  }
  
  .history-item span { 
    word-break:break-word; 
    flex: 1;
    padding-right: 15px;
    color: var(--foreground);
  }
  
  .history-item button { 
    background: #ef4444; 
    color: #fff; 
    border: none; 
    border-radius: 50px; 
    padding: 10px 20px; 
    cursor: pointer; 
    transition: all 0.4s ease;
    font-weight: 500;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
  }

  .history-item button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: 0.5s;
  }

  .history-item button:hover::before {
    left: 100%;
  }
  
  .history-item button:hover {
    background: #dc2626;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
  }

  .ai-output { 
    margin-top:20px; 
    background: var(--muted); 
    padding:20px; 
    border-radius:12px; 
    border:1px solid var(--border); 
    min-height:100px; 
    white-space:normal;
    transition: var(--transition);
    color: var(--foreground);
  }
  
  .ai-output:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
  }
  
  .ai-output h1, .ai-output h2, .ai-output h3 { 
    margin-top:15px; 
    color: var(--primary); 
  }
  
  .ai-output ul { 
    padding-left:25px; 
  }
  
  .note { 
    font-weight: 500; 
    font-size: 14px; 
    color: var(--muted-foreground);
    background: var(--muted);
    padding: 15px;
    border-radius: 12px;
    border-left: 4px solid var(--border);
  }
  
  input[type="text"], input[type="date"] {
    padding: 10px 15px;
    border: 1px solid var(--border);
    border-radius: 8px;
    margin: 5px 0;
    transition: var(--transition);
    background: var(--muted);
    color: var(--foreground);
  }
  
  input[type="text"]:focus, input[type="date"]:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.2);
  }
  
  .features ul {
    padding-left: 25px;
  }
  
  .features li {
    margin-bottom: 10px;
    position: relative;
    padding-left: 25px;
    color: var(--foreground);
  }
  
  .features li::before {
    content: "✓";
    color: var(--primary);
    position: absolute;
    left: 0;
    font-weight: bold;
  }

  /* Theme Dropdown */
  .theme-dropdown {
    position: relative;
    display: inline-block;
  }

  .theme-btn {
    padding: 15px;
    border: none;
    background: transparent;
    cursor: pointer;
    display: flex;
     border: 2px solid #16a34a;
     border-radius: 25px;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    color: var(--foreground);
  }

  .theme-btn:hover {
    background: var(--muted);
  }

  .theme-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    min-width: 120px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: var(--transition);
    z-index: 1000;
  }

  .theme-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .theme-option {
    padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      color: var(--foreground);
  }

  .theme-option:hover {
    background: var(--muted);
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes fadeInUp {
    from { 
      opacity: 0;
      transform: translateY(20px);
    }
    to { 
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes slideDown {
    from { 
      transform: translateY(-20px);
      opacity: 0;
    }
    to { 
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }
  
  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
    40% {transform: translateY(-15px);}
    60% {transform: translateY(-7px);}
  }

  /* Scroll animations */
  .animate-on-scroll {
    opacity: 0;
    transform: translateY(30px);
    transition: all 0.8s ease-out;
  }

  .animate-on-scroll.animate-in {
    opacity: 1;
    transform: translateY(0);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    header {
      flex-direction: column;
      text-align: center;
      gap: 10px;
    }
    
    .menu {
      gap: 8px;
    }
    
    .menu button, .btn.logout {
      padding: 10px 18px;
      font-size: 14px;
    }
    
    .upload-area {
      padding: 25px 15px;
    }
    
    .user-card, .ocr-section, .history-section, .features {
      padding: 20px 15px;
    }
    
    .btn.extract, .btn.analyze {
      padding: 12px 24px;
      font-size: 16px;
    }
  }
  .logo {
      height: 50px;
    }
    .age{
      font-weight: bold;
    }
    .logo { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      font-size: 26px; 
      font-weight: 800; 
      color: var(--primary);
      cursor: pointer;
    }
    /* Add these styles to your existing CSS */
.ai-output .positive {
  color: #16a34a; /* Green */
  font-weight: 600;
}

.ai-output .negative {
  color: #dc2626; /* Red */
  font-weight: 600;
}

.ai-output .positive-icon::before {
  content: "✅ ";
}

.ai-output .negative-icon::before {
  content: "❌ ";
}
</style>
</head>
<body>
<header>
  <div class="logo" onclick="window.location.href='index.html'"> <img src="img/logo.png" alt="Logo" class="logo"></div>
  <div class="theme-dropdown">
    <button class="theme-btn" id="theme-btn" onclick="toggleThemeMenu()">
      <span id="theme-icon"><i class="fas fa-moon"></i></span>
    </button>
    <div class="theme-menu" id="theme-menu">
      <button class="theme-option" onclick="setTheme('system')">
        <i class="fas fa-desktop"></i> System
      </button>
      <button class="theme-option" onclick="setTheme('light')">
        <i class="fas fa-sun"></i> Light
      </button>
      <button class="theme-option" onclick="setTheme('dark')">
        <i class="fas fa-moon"></i> Dark
      </button>
    </div>
  </div>
</header>

<section>
  <div class="menu">
    <button id="menuDashboard" class="active" onclick="showSection('dashboard')">
      <i class="fas fa-home"></i> Dashboard
    </button>
    <button id="menuScan" onclick="showSection('scan')">
      <i class="fas fa-camera"></i> Ingre Scan
    </button>
    <button id="menuHistory" onclick="showSection('history')">
      <i class="fas fa-history"></i> History
    </button>
    <button class="btn logout" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>
  <div class="header-right" id="welcomeName">Welcome!</div>
</section>

<main>
  <!-- Dashboard Section -->
  <div id="dashboard" class="section active">
    <div class="user-card">
      <h2 class="section-title"><i class="fas fa-user"></i> Your Information</h2>
      <p><strong>Name:</strong> <span id="userName">Loading...</span></p>
      <p><strong>Email:</strong> <span id="userEmail">Loading...</span></p>
      <p><strong>User ID:</strong> <span id="userId">Loading...</span></p>
      <p>
        <strong>Health Issues:</strong>
        <input type="text" id="userIssuesInput" placeholder="e.g. diabetes, hypertension">
        <button class="btn analyze" onclick="saveHealthIssues()">Save</button>
      </p>
      <p>
        <strong>Date of Birth:</strong>
        <input type="date" id="userDOB" onchange="calculateAge()">
        
        <button class="btn analyze" onclick="saveDOB()">Save/Update DOB</button>
      </p>
      <div class="age">
      <span id="calculatedAge">Age: N/A</span>
      </div>
    </div>
    <div class="features">
      <h3 class="section-title"><i class="fas fa-star"></i> Features</h3>
      <ul>
        <li>Scan food ingredients using Inge Scan</li>
        <li>View scan history in History page</li>
        <li>AI-powered food & health analysis</li>
        <li>Secure and private with AES encryption</li>
      </ul>
    </div>
  </div>

  <!-- Inge Scan Section -->
  <div id="scan" class="section">
    <div class="ocr-section">
      <h2 class="section-title"><i class="fas fa-camera"></i> Scan Ingredients</h2>
      <div id="dropArea" class="upload-area">
        <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
        <p>Drag & drop or click to upload an image<br>(Image Must Be Less Than 1MB)</p>
        <input type="file" id="fileInput" hidden accept="image/*">
      </div>
      <div class="image-preview" id="previewContainer" style="display:none;">
        <img id="previewImage" alt="Preview">
      </div>
      <button class="btn extract" onclick="uploadImage()"><i class="fas fa-text"></i> Extract Text</button>
      <button class="btn analyze" onclick="analyzeText()"><i class="fas fa-brain"></i> Analyze</button>
      <textarea id="ocrResult" placeholder="Extracted text will appear here...
Or Just Type Here."></textarea>
      <div class="ai-output" id="aiOutput">AI analysis will appear here...</div>
    </div>
    <div class="note">
      <p><i class="fas fa-info-circle"></i> Transparency Note: Our AI provides data-driven suggestions. For definitive food safety and nutritional advice, we recommend consulting certified professionals.</p>
    </div>
  </div>
  

  <!-- History Section -->
  <div id="history" class="section">
    <h2 class="section-title"><i class="fas fa-history"></i> Scan History</h2>
    <ul class="history-list" id="historyList"><li>Loading...</li></ul>
  </div>
</main>

<script>
  // ---------- Theme Management ----------
  let currentTheme = localStorage.getItem('theme') || 'system';
  
  function updateThemeIcon() {
    const resolvedTheme = getResolvedTheme();
    const icon = resolvedTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
    const systemIcon = currentTheme === 'system' ? '<i class="fas fa-desktop"></i>' : icon;
    document.getElementById('theme-icon').innerHTML = systemIcon;
  }

  function getResolvedTheme() {
    if (currentTheme === 'system') {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    return currentTheme;
  }

  function applyTheme() {
    const resolvedTheme = getResolvedTheme();
    if (resolvedTheme === 'dark') document.body.classList.add('dark');
    else document.body.classList.remove('dark');
    updateThemeIcon();
  }

  function setTheme(theme) {
    currentTheme = theme;
    localStorage.setItem('theme', theme);
    applyTheme();
    toggleThemeMenu();
  }

  function toggleThemeMenu() {
    const menu = document.getElementById('theme-menu');
    menu.classList.toggle('show');
  }

  function handleOutsideClick(event) {
    const themeMenu = document.getElementById('theme-menu');
    if (!event.target.closest('.theme-dropdown')) themeMenu.classList.remove('show');
  }

  // ---------- Scroll Animations ----------
  function initScrollAnimations() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) entry.target.classList.add('animate-in');
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });
    document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));
  }

  // ---------- User Management ----------
const user = JSON.parse(localStorage.getItem("user")||"{}");
  document.getElementById("userName").textContent = user.fullName||"N/A";
  document.getElementById("userEmail").textContent = user.email||"N/A";
  document.getElementById("userId").textContent = user.userId || "N/A";
  document.getElementById("userIssuesInput").value = user.healthIssues ? user.healthIssues.join(", ") : "";
  document.getElementById("welcomeName").textContent = `Welcome, ${user.fullName||"User"}!`;
  if(user.dob){
    document.getElementById("userDOB").value = user.dob;
    calculateAge();
  }

  // ---------- Health Issues ----------
  async function saveHealthIssues(){
    const issuesInput = document.getElementById("userIssuesInput").value.trim();
    const issuesArray = issuesInput ? issuesInput.split(",").map(i=>i.trim()) : [];
    try {
      const res = await fetch("/updateHealthIssues", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({userId:user.userId, healthIssues:issuesArray})
      });
      const data = await res.json();
      if(data.success){
        user.healthIssues = issuesArray;
        localStorage.setItem("user", JSON.stringify(user));
      
      } else alert("❌ Failed to update health issues.");
    } catch(err){ alert("❌ Server error."); }
  }

  // ---------- DOB & Age ----------
  function calculateAge(){
    const dob = document.getElementById("userDOB").value;
    if(!dob){ document.getElementById("calculatedAge").textContent = "Age: N/A"; return; }
    const birthDate = new Date(dob);
    const diff = Date.now() - birthDate.getTime();
    const ageDate = new Date(diff);
    const age = Math.abs(ageDate.getUTCFullYear() - 1970);
    document.getElementById("calculatedAge").textContent = `Age: ${age}`;
  }

  async function saveDOB(){
    const dob = document.getElementById("userDOB").value;
    if(!dob) return alert("Please select your date of birth!");
    try {
      const res = await fetch("/updateDOB", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({userId:user.userId, dob})
      });
      const data = await res.json();
      if(data.success){
        user.dob = dob;
        localStorage.setItem("user", JSON.stringify(user));
        calculateAge();
        
      } else alert("❌ Failed to update DOB.");
    } catch(err){ alert("❌ Server error."); }
  }

  // ---------- File Upload / OCR ----------
  const dropArea = document.getElementById("dropArea"),
        fileInput = document.getElementById("fileInput"),
        previewImage = document.getElementById("previewImage"),
        previewContainer = document.getElementById("previewContainer");

  dropArea.addEventListener("click", ()=>fileInput.click());
  fileInput.addEventListener("change", ()=>handleFile(fileInput.files[0]));
  dropArea.addEventListener("dragover", e=>{ e.preventDefault(); dropArea.style.background="rgba(22,163,74,0.1)"; });
  dropArea.addEventListener("dragleave", ()=>dropArea.style.background="rgba(22,163,74,0.03)");
  dropArea.addEventListener("drop", e=>{ e.preventDefault(); const file=e.dataTransfer.files[0]; if(file) handleFile(file); });

  function handleFile(file){
    const reader = new FileReader();
    reader.onload = e=>{ previewImage.src=e.target.result; previewContainer.style.display="block"; };
    reader.readAsDataURL(file);
  }

  async function uploadImage(){
    const file = fileInput.files[0];
    if(!file) return alert("Please upload an image first!");
    const formData = new FormData();
    formData.append("file", file);
    formData.append("userId", user.userId);
    document.getElementById("ocrResult").value = "⏳ Processing...";
    try{
      const res = await fetch("/ocr", { method:"POST", body: formData });
      const data = await res.json();
      document.getElementById("ocrResult").value = data.extracted_text;
      document.getElementById("aiOutput").textContent = "AI analysis will appear here...";
    } catch(err){ document.getElementById("ocrResult").value = "❌ OCR failed."; }
  }

  // ---------- AI Analysis ----------
  async function analyzeText(){
    const text = document.getElementById("ocrResult").value;
    if(!text.trim()) return alert("No text to analyze!");
    const aiOutput = document.getElementById("aiOutput");
    aiOutput.textContent = "⏳ AI analyzing...";
    try{
      const res = await fetch("/analyze", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({userId:user.userId, text, healthIssues:user.healthIssues||[], dob:user.dob||null})
      });
      const data = await res.json();
      if(data.success) aiOutput.innerHTML = marked.parse(data.analysis);
      else aiOutput.textContent = "❌ AI analysis failed.";
    } catch(err){ aiOutput.textContent = "❌ AI analysis failed."; }
  }

  // ---------- History ----------
  async function loadHistory(){
    const list = document.getElementById("historyList");
    list.innerHTML = "Loading...";
    try{
      const res = await fetch("/history?userId="+encodeURIComponent(user.userId));
      const data = await res.json();
      if(!data.history || data.history.length===0) list.innerHTML = "<li>No scans yet.</li>";
      else {
        list.innerHTML = "";
        data.history.forEach((h,i)=>{
          const li = document.createElement("li");
          li.className = "history-item";
          li.innerHTML = `<span>${h.text}</span><button onclick="deleteHistory(${i})">Delete</button>`;
          list.appendChild(li);
        });
      }
    } catch(err){ list.innerHTML = "<li>Error loading history.</li>"; }
  }

  async function deleteHistory(index){
    if(!confirm("Delete this history?")) return;
    try{
      const res = await fetch("/history", {
        method:"DELETE",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({userId:user.userId,index})
      });
      const data = await res.json();
      if(data.success) loadHistory();
      else alert("❌ Failed to delete history.");
    } catch(err){ alert("❌ Server error."); }
  }

  // ---------- Logout ----------
  function logout(){
    localStorage.removeItem("loggedIn");
    localStorage.removeItem("user");
    window.location.href = "signin.html";
  }

  // ---------- Section Navigation ----------
  function showSection(id){
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
    document.getElementById('menu'+id.charAt(0).toUpperCase()+id.slice(1)).classList.add('active');
    if(id==='history') loadHistory();
  }

  // ---------- Initialization ----------
  document.addEventListener('DOMContentLoaded', function() {
    applyTheme();
    initScrollAnimations();
    document.addEventListener('click', handleOutsideClick);
    window.matchMedia('(prefers-color-scheme: dark)')?.addEventListener('change', () => {
      if (currentTheme === 'system') applyTheme();
    });
  });
</script>

</body>
</html>